#include "ssd1306spi.h"

static const uint8_t FONTS[] = { // 16x7
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x19,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x09, 0x00, 0x07, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x09, 0x00, 0x07, 0x00, 0x00, 0x02, 0x20, 0x1e, 0xe0, 0x03,
    0x3c, 0x02, 0x20, 0x1e, 0xe0, 0x03, 0x3c, 0x02, 0x1c, 0x04, 0x22, 0x08,
    0x42, 0x08, 0xff, 0x1f, 0x42, 0x08, 0x82, 0x08, 0x04, 0x07, 0x06, 0x18,
    0x09, 0x06, 0x89, 0x01, 0x46, 0x0c, 0x30, 0x12, 0x0c, 0x12, 0x03, 0x0c,
    0x80, 0x0f, 0xde, 0x18, 0x61, 0x10, 0xa1, 0x11, 0x11, 0x16, 0x0e, 0x08,
    0x80, 0x17, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x06, 0x0c, 0x01, 0x10,
    0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0x10,
    0x06, 0x0c, 0xf8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00,
    0x60, 0x00, 0xf8, 0x01, 0x60, 0x00, 0x90, 0x00, 0x00, 0x00, 0x40, 0x00,
    0x40, 0x00, 0x40, 0x00, 0xf8, 0x03, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00,
    0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x1c,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x80, 0x03,
    0x60, 0x00, 0x1c, 0x00, 0x03, 0x00, 0x00, 0x00, 0xfc, 0x07, 0x02, 0x08,
    0x81, 0x10, 0x41, 0x10, 0x21, 0x10, 0x02, 0x08, 0xfc, 0x07, 0x00, 0x00,
    0x04, 0x00, 0x02, 0x00, 0x01, 0x00, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x06, 0x1c, 0x01, 0x13, 0x81, 0x10, 0x41, 0x10, 0x21, 0x10,
    0x1e, 0x10, 0x00, 0x00, 0x02, 0x08, 0x01, 0x10, 0x21, 0x10, 0x21, 0x10,
    0x21, 0x10, 0xde, 0x0f, 0x80, 0x01, 0x40, 0x01, 0x30, 0x01, 0x08, 0x01,
    0x06, 0x01, 0xff, 0x1f, 0x00, 0x01, 0x00, 0x00, 0x3f, 0x08, 0x21, 0x10,
    0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0xc1, 0x0f, 0x00, 0x00, 0xfe, 0x0f,
    0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0xc2, 0x0f, 0x01, 0x00,
    0x01, 0x00, 0x01, 0x1e, 0xc1, 0x01, 0x21, 0x00, 0x19, 0x00, 0x07, 0x00,
    0x00, 0x00, 0xde, 0x0f, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10,
    0xde, 0x0f, 0x00, 0x00, 0x3e, 0x08, 0x41, 0x10, 0x41, 0x10, 0x41, 0x10,
    0x41, 0x10, 0xfe, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x06,
    0x18, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x0a, 0x18, 0x06, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0xa0, 0x00,
    0xa0, 0x00, 0x10, 0x01, 0x08, 0x02, 0x08, 0x02, 0x04, 0x04, 0x10, 0x01,
    0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01,
    0x04, 0x04, 0x08, 0x02, 0x08, 0x02, 0x10, 0x01, 0xa0, 0x00, 0xa0, 0x00,
    0x40, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x19, 0x41, 0x00,
    0x21, 0x00, 0x1e, 0x00, 0xfc, 0x07, 0x02, 0x08, 0xe1, 0x11, 0x11, 0x12,
    0x11, 0x12, 0x12, 0x12, 0xfc, 0x09, 0xc0, 0x1f, 0xb8, 0x00, 0x86, 0x00,
    0x81, 0x00, 0x86, 0x00, 0xb8, 0x00, 0xc0, 0x1f, 0xff, 0x1f, 0x21, 0x10,
    0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0xde, 0x0f, 0xfc, 0x07,
    0x02, 0x08, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x02, 0x08,
    0xff, 0x1f, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x02, 0x08,
    0xfc, 0x07, 0xff, 0x1f, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10, 0x21, 0x10,
    0x01, 0x10, 0x00, 0x00, 0xff, 0x1f, 0x21, 0x00, 0x21, 0x00, 0x21, 0x00,
    0x21, 0x00, 0x01, 0x00, 0x00, 0x00, 0xfe, 0x0f, 0x01, 0x10, 0x01, 0x10,
    0x01, 0x10, 0x81, 0x10, 0x81, 0x10, 0x82, 0x0f, 0xff, 0x1f, 0x20, 0x00,
    0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0xff, 0x1f, 0x00, 0x00,
    0x01, 0x10, 0x01, 0x10, 0xff, 0x1f, 0x01, 0x10, 0x01, 0x10, 0x00, 0x00,
    0x01, 0x0c, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10,
    0xff, 0x0f, 0xff, 0x1f, 0x40, 0x00, 0x60, 0x00, 0x98, 0x00, 0x04, 0x03,
    0x03, 0x0c, 0x00, 0x10, 0xff, 0x1f, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
    0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0xff, 0x1f, 0x02, 0x00, 0x0c, 0x00,
    0x10, 0x00, 0x0c, 0x00, 0x02, 0x00, 0xff, 0x1f, 0xff, 0x1f, 0x02, 0x00,
    0x0c, 0x00, 0x10, 0x00, 0x60, 0x00, 0x80, 0x00, 0xff, 0x1f, 0xfc, 0x07,
    0x02, 0x08, 0x01, 0x10, 0x01, 0x10, 0x01, 0x10, 0x02, 0x08, 0xfc, 0x07,
    0xff, 0x1f, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x22, 0x00,
    0x1c, 0x00, 0xfc, 0x07, 0x02, 0x08, 0x01, 0x10, 0x01, 0x10, 0x01, 0x14,
    0x02, 0x08, 0xfc, 0x17, 0xff, 0x1f, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00,
    0xc1, 0x00, 0x41, 0x03, 0x3e, 0x1c, 0x1c, 0x04, 0x22, 0x08, 0x41, 0x10,
    0x41, 0x10, 0x41, 0x10, 0x82, 0x08, 0x04, 0x07, 0x01, 0x00, 0x01, 0x00,
    0x01, 0x00, 0xff, 0x1f, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0xff, 0x07,
    0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0xff, 0x07,
    0x0f, 0x00, 0xf0, 0x00, 0x00, 0x07, 0x00, 0x18, 0x00, 0x07, 0xf0, 0x00,
    0x0f, 0x00, 0xff, 0x07, 0x00, 0x18, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x07,
    0x00, 0x18, 0xff, 0x07, 0x03, 0x18, 0x0c, 0x06, 0xb0, 0x01, 0x40, 0x00,
    0xb0, 0x01, 0x0c, 0x06, 0x03, 0x18, 0x07, 0x00, 0x18, 0x00, 0x60, 0x00,
    0x80, 0x1f, 0x60, 0x00, 0x18, 0x00, 0x07, 0x00, 0x01, 0x1c, 0x01, 0x13,
    0x81, 0x10, 0x61, 0x10, 0x19, 0x10, 0x05, 0x10, 0x03, 0x10, 0x00, 0x00,
    0x00, 0x00, 0xff, 0x1f, 0x01, 0x10, 0x01, 0x10, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x00, 0x38, 0x00, 0xc0, 0x00, 0x00, 0x07, 0x00, 0x18,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x01, 0x10, 0xff, 0x1f,
    0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x04, 0x00, 0x02, 0x00, 0x01, 0x00,
    0x02, 0x00, 0x04, 0x00, 0x08, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
    0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x01, 0x00,
    0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x0f, 0x88, 0x10, 0x88, 0x10, 0x88, 0x10, 0x88, 0x08, 0xf0, 0x1f,
    0x00, 0x00, 0xff, 0x1f, 0x10, 0x08, 0x08, 0x10, 0x08, 0x10, 0x08, 0x10,
    0xf0, 0x0f, 0x00, 0x00, 0xe0, 0x07, 0x10, 0x08, 0x08, 0x10, 0x08, 0x10,
    0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0xf0, 0x0f, 0x08, 0x10, 0x08, 0x10,
    0x08, 0x10, 0x10, 0x08, 0xff, 0x1f, 0x00, 0x00, 0xf0, 0x0f, 0x88, 0x10,
    0x88, 0x10, 0x88, 0x10, 0x88, 0x10, 0xf0, 0x08, 0x10, 0x00, 0x10, 0x00,
    0xfe, 0x1f, 0x11, 0x00, 0x11, 0x00, 0x11, 0x00, 0x02, 0x00, 0xf0, 0x76,
    0x08, 0x89, 0x08, 0x89, 0x08, 0x89, 0x08, 0x89, 0xf8, 0x88, 0x08, 0x70,
    0x00, 0x00, 0xff, 0x1f, 0x10, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
    0xf0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x08, 0x10, 0xf9, 0x1f,
    0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x20, 0x00, 0x40, 0x08, 0x40,
    0x08, 0x40, 0xf9, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xff, 0x1f, 0x80, 0x01,
    0x40, 0x01, 0x20, 0x02, 0x10, 0x04, 0x08, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x10, 0x01, 0x10, 0xff, 0x1f, 0x00, 0x10, 0x00, 0x10, 0xf8, 0x1f,
    0x08, 0x00, 0x08, 0x00, 0xf0, 0x1f, 0x08, 0x00, 0x08, 0x00, 0xf0, 0x1f,
    0x00, 0x00, 0xf8, 0x1f, 0x10, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
    0xf0, 0x1f, 0xe0, 0x07, 0x10, 0x08, 0x08, 0x10, 0x08, 0x10, 0x08, 0x10,
    0x10, 0x08, 0xe0, 0x07, 0x00, 0x00, 0xf8, 0xff, 0x10, 0x08, 0x08, 0x10,
    0x08, 0x10, 0x08, 0x10, 0xf0, 0x0f, 0x00, 0x00, 0xf0, 0x0f, 0x08, 0x10,
    0x08, 0x10, 0x08, 0x10, 0x10, 0x08, 0xf8, 0xff, 0x00, 0x00, 0xf8, 0x1f,
    0x10, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x10, 0x00, 0x00, 0x08,
    0x70, 0x10, 0x88, 0x10, 0x88, 0x10, 0x08, 0x11, 0x08, 0x11, 0x10, 0x0e,
    0x08, 0x00, 0x08, 0x00, 0xff, 0x0f, 0x08, 0x10, 0x08, 0x10, 0x08, 0x10,
    0x00, 0x08, 0x00, 0x00, 0xf8, 0x0f, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10,
    0x00, 0x08, 0xf8, 0x1f, 0x38, 0x00, 0xc0, 0x01, 0x00, 0x0e, 0x00, 0x10,
    0x00, 0x0e, 0xc0, 0x01, 0x38, 0x00, 0xf8, 0x07, 0x00, 0x18, 0x00, 0x06,
    0x80, 0x01, 0x00, 0x06, 0x00, 0x18, 0xf8, 0x07, 0x18, 0x18, 0x20, 0x04,
    0x40, 0x02, 0x80, 0x01, 0x40, 0x02, 0x20, 0x04, 0x18, 0x18, 0x18, 0x00,
    0xe0, 0xc0, 0x00, 0x33, 0x00, 0x0c, 0x00, 0x03, 0xe0, 0x00, 0x18, 0x00,
    0x08, 0x18, 0x08, 0x14, 0x08, 0x12, 0x88, 0x11, 0x48, 0x10, 0x28, 0x10,
    0x18, 0x10, 0x00, 0x00, 0x00, 0x00, 0x4e, 0x0e, 0xb1, 0x11, 0x01, 0x10,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x1f,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x10, 0xb1, 0x11, 0x4e, 0x0e, 0x00, 0x00, 0x80, 0x00, 0x40, 0x00,
    0x40, 0x00, 0x80, 0x00, 0x00, 0x01, 0x00, 0x01, 0x80, 0x00};


void ssdPutBuffer(SSDspi *ssd, const uint8_t * buffer, uint8_t length, uint8_t bytesInColumn, uint8_t row, uint8_t col) {
  uint16_t i = col * ssd->bytesPerColumn + row;
  if (row >
      ssd->bytesPerColumn - bytesInColumn) // need 2 rows left to fit a char (height: 16)
    return;
  if (col > ssd->width - length / bytesInColumn) // need 8 cols left to fit a char (width: 7)
    return;
  for (int8_t j = 0; j < length;) {
    for (uint8_t k = 0; k < bytesInColumn; k++) {
      ssd->buffer[i + k] = buffer[j++];
    }
    i += ssd->bytesPerColumn;
  }
}

void ssdPutFont(SSDspi *ssd, char c, uint8_t row, uint8_t col) {
  ssdPutBuffer(ssd, FONTS + (c - ' ') * 14, 14, 2, row, col);
}

void ssdPutString(SSDspi *ssd, const char *s, uint8_t row, uint8_t col) {
  uint8_t i = 0;
  while (s[i]) {
    ssdPutFont(ssd, s[i++], row, col);
    col += 8;
    if (col == ssd->width) {
      col = 0;
      row += 2;
    }
  }
}

void ssdClear(SSDspi *ssd, uint8_t v) {
  memset(ssd->buffer, v, ssd->bufferLength);
}

void ssdRefresh(SSDspi *ssd) {
  if (ssd->cs.pin) {
    gpioReset(&ssd->cs);
  }

  // SPI0_MasterDMATrans(ssd->buffer, ssd->bufferLength);
  SPI0_MasterTrans((uint8_t[]){0xAE}, 1); // turn off

  if (ssd->cs.pin) {
    gpioSet(&ssd->cs);
  }
}

void ssdInit(SSDspi *ssd, uint8_t width, uint8_t height) {
  ssd->bytesPerColumn = height >> 3;
  ssd->bufferLength = ssd->bytesPerColumn * width;
  ssd->width = width;
  ssd->height = height;
  ssd->buffer = (uint8_t *)malloc(ssd->bufferLength);

  ssdClear(ssd, 0x00);

  gpioMode(&ssd->sclk, GPIO_ModeOut_PP_5mA);
  gpioMode(&ssd->mosi, GPIO_ModeOut_PP_5mA);

  gpioMode(&ssd->rst, GPIO_ModeOut_PP_5mA);
  gpioMode(&ssd->dc, GPIO_ModeOut_PP_5mA);

  if (ssd->cs.pin) {
    gpioMode(&ssd->cs, GPIO_ModeOut_PP_5mA);
  }

  SPI0_MasterDefInit();
  R8_SPI0_CLOCK_DIV = 32;

  gpioReset(&ssd->rst);
  DelayMs(200);
  gpioSet(&ssd->rst);

  gpioReset(&ssd->dc);

  if (ssd->cs.pin) {
    gpioReset(&ssd->cs);
  }

  SPI0_MasterTrans((uint8_t[]){0xAE}, 1); // turn off

  SPI0_MasterTrans((uint8_t[]){0x81, 0x80}, 2); // contrast
  SPI0_MasterTrans((uint8_t[]){0xA8, ssd->height - 1},
                   2);                          // Multiplex ratio, height - 1
  SPI0_MasterTrans((uint8_t[]){0xD3, 0x00}, 2); // set display offset
  SPI0_MasterTrans((uint8_t[]){0xD5, 0x80}, 2); // set osc division

  SPI0_MasterTrans((uint8_t[]){0xD9, 0x1f}, 2); // set pre-charge period

  SPI0_MasterTrans((uint8_t[]){0xDB, 0x40}, 2); // set vcomh
  SPI0_MasterTrans((uint8_t[]){0x8D, 0x14}, 2); // set charge pump enable

  SPI0_MasterTrans((uint8_t[]){0xA6}, 1); // Display: A6: normal, A7: inverse

  SPI0_MasterTrans((uint8_t[]){0x20, 0x01}, 2); // Memeory Address Mode

  SPI0_MasterTrans((uint8_t[]){0x21, 0x00, ssd->width - 1},
                   3); // Set Column Address
  SPI0_MasterTrans((uint8_t[]){0x22, 0x00, ssd->bytesPerColumn - 1},
                   3); // Set Page Address

  SPI0_MasterTrans((uint8_t[]){0xDA, ssd->height == 64 ? 0x10 : 0x00},
                   2); // set COM pins
  SPI0_MasterTrans((uint8_t[]){0xC8},
                   1); // COM Direction: C0: low to high, C8: high to low
  SPI0_MasterTrans((uint8_t[]){0xA1},
                   1); // Segment mapping: A0: low to high, A1: high to low

  SPI0_MasterTrans((uint8_t[]){0x2e}, 1); // turn off scroll

  SPI0_MasterTrans((uint8_t[]){0x40}, 1); // display start line at 0
  SPI0_MasterTrans((uint8_t[]){0xb0}, 1); // page start at 0

  SPI0_MasterTrans((uint8_t[]){0xAF}, 1); // turn on

  if (ssd->cs.pin) {
    gpioSet(&ssd->cs);
  }

  gpioSet(&ssd->dc);

  ssdRefresh(ssd);
}
