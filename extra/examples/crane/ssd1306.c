#include "ssd1306.h"

static uint8_t screen[1024];

static const uint8_t FONTS[] = {  // 16x7
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x19,0x00,0x00,0x00,0x00,0x01,0x00,0x09,0x00,0x07,0x00,0x00,0x00,0x01,0x00,0x09,0x00,0x07,0x00,0x00,0x02,0x20,0x1e,0xe0,0x03,0x3c,0x02,0x20,0x1e,0xe0,0x03,0x3c,0x02,0x1c,0x04,0x22,0x08,0x42,0x08,0xff,0x1f,0x42,0x08,0x82,0x08,0x04,0x07,0x06,0x18,0x09,0x06,0x89,0x01,0x46,0x0c,0x30,0x12,0x0c,0x12,0x03,0x0c,0x80,0x0f,0xde,0x18,0x61,0x10,0xa1,0x11,0x11,0x16,0x0e,0x08,0x80,0x17,0x00,0x00,0x00,0x00,0x09,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0x03,0x06,0x0c,0x01,0x10,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x01,0x10,0x06,0x0c,0xf8,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x00,0x60,0x00,0xf8,0x01,0x60,0x00,0x90,0x00,0x00,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0xf8,0x03,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0x00,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x80,0x03,0x60,0x00,0x1c,0x00,0x03,0x00,0x00,0x00,0xfc,0x07,0x02,0x08,0x81,0x10,0x41,0x10,0x21,0x10,0x02,0x08,0xfc,0x07,0x00,0x00,0x04,0x00,0x02,0x00,0x01,0x00,0xff,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x1c,0x01,0x13,0x81,0x10,0x41,0x10,0x21,0x10,0x1e,0x10,0x00,0x00,0x02,0x08,0x01,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0xde,0x0f,0x80,0x01,0x40,0x01,0x30,0x01,0x08,0x01,0x06,0x01,0xff,0x1f,0x00,0x01,0x00,0x00,0x3f,0x08,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0xc1,0x0f,0x00,0x00,0xfe,0x0f,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0xc2,0x0f,0x01,0x00,0x01,0x00,0x01,0x1e,0xc1,0x01,0x21,0x00,0x19,0x00,0x07,0x00,0x00,0x00,0xde,0x0f,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0xde,0x0f,0x00,0x00,0x3e,0x08,0x41,0x10,0x41,0x10,0x41,0x10,0x41,0x10,0xfe,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x06,0x18,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x0a,0x18,0x06,0x00,0x00,0x00,0x00,0x40,0x00,0xa0,0x00,0xa0,0x00,0x10,0x01,0x08,0x02,0x08,0x02,0x04,0x04,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x04,0x04,0x08,0x02,0x08,0x02,0x10,0x01,0xa0,0x00,0xa0,0x00,0x40,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x81,0x19,0x41,0x00,0x21,0x00,0x1e,0x00,0xfc,0x07,0x02,0x08,0xe1,0x11,0x11,0x12,0x11,0x12,0x12,0x12,0xfc,0x09,0xc0,0x1f,0xb8,0x00,0x86,0x00,0x81,0x00,0x86,0x00,0xb8,0x00,0xc0,0x1f,0xff,0x1f,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0xde,0x0f,0xfc,0x07,0x02,0x08,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x02,0x08,0xff,0x1f,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x02,0x08,0xfc,0x07,0xff,0x1f,0x21,0x10,0x21,0x10,0x21,0x10,0x21,0x10,0x01,0x10,0x00,0x00,0xff,0x1f,0x21,0x00,0x21,0x00,0x21,0x00,0x21,0x00,0x01,0x00,0x00,0x00,0xfe,0x0f,0x01,0x10,0x01,0x10,0x01,0x10,0x81,0x10,0x81,0x10,0x82,0x0f,0xff,0x1f,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0xff,0x1f,0x00,0x00,0x01,0x10,0x01,0x10,0xff,0x1f,0x01,0x10,0x01,0x10,0x00,0x00,0x01,0x0c,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0x01,0x10,0xff,0x0f,0xff,0x1f,0x40,0x00,0x60,0x00,0x98,0x00,0x04,0x03,0x03,0x0c,0x00,0x10,0xff,0x1f,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0xff,0x1f,0x02,0x00,0x0c,0x00,0x10,0x00,0x0c,0x00,0x02,0x00,0xff,0x1f,0xff,0x1f,0x02,0x00,0x0c,0x00,0x10,0x00,0x60,0x00,0x80,0x00,0xff,0x1f,0xfc,0x07,0x02,0x08,0x01,0x10,0x01,0x10,0x01,0x10,0x02,0x08,0xfc,0x07,0xff,0x1f,0x41,0x00,0x41,0x00,0x41,0x00,0x41,0x00,0x22,0x00,0x1c,0x00,0xfc,0x07,0x02,0x08,0x01,0x10,0x01,0x10,0x01,0x14,0x02,0x08,0xfc,0x17,0xff,0x1f,0x41,0x00,0x41,0x00,0x41,0x00,0xc1,0x00,0x41,0x03,0x3e,0x1c,0x1c,0x04,0x22,0x08,0x41,0x10,0x41,0x10,0x41,0x10,0x82,0x08,0x04,0x07,0x01,0x00,0x01,0x00,0x01,0x00,0xff,0x1f,0x01,0x00,0x01,0x00,0x01,0x00,0xff,0x07,0x00,0x08,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x08,0xff,0x07,0x0f,0x00,0xf0,0x00,0x00,0x07,0x00,0x18,0x00,0x07,0xf0,0x00,0x0f,0x00,0xff,0x07,0x00,0x18,0x00,0x07,0xc0,0x00,0x00,0x07,0x00,0x18,0xff,0x07,0x03,0x18,0x0c,0x06,0xb0,0x01,0x40,0x00,0xb0,0x01,0x0c,0x06,0x03,0x18,0x07,0x00,0x18,0x00,0x60,0x00,0x80,0x1f,0x60,0x00,0x18,0x00,0x07,0x00,0x01,0x1c,0x01,0x13,0x81,0x10,0x61,0x10,0x19,0x10,0x05,0x10,0x03,0x10,0x00,0x00,0x00,0x00,0xff,0x1f,0x01,0x10,0x01,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x38,0x00,0xc0,0x00,0x00,0x07,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x10,0x01,0x10,0xff,0x1f,0x00,0x00,0x00,0x00,0x08,0x00,0x04,0x00,0x02,0x00,0x01,0x00,0x02,0x00,0x04,0x00,0x08,0x00,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x00,0x01,0x00,0x02,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x0f,0x88,0x10,0x88,0x10,0x88,0x10,0x88,0x08,0xf0,0x1f,0x00,0x00,0xff,0x1f,0x10,0x08,0x08,0x10,0x08,0x10,0x08,0x10,0xf0,0x0f,0x00,0x00,0xe0,0x07,0x10,0x08,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x08,0x00,0x00,0xf0,0x0f,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x08,0xff,0x1f,0x00,0x00,0xf0,0x0f,0x88,0x10,0x88,0x10,0x88,0x10,0x88,0x10,0xf0,0x08,0x10,0x00,0x10,0x00,0xfe,0x1f,0x11,0x00,0x11,0x00,0x11,0x00,0x02,0x00,0xf0,0x76,0x08,0x89,0x08,0x89,0x08,0x89,0x08,0x89,0xf8,0x88,0x08,0x70,0x00,0x00,0xff,0x1f,0x10,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0xf0,0x1f,0x00,0x00,0x00,0x00,0x08,0x10,0x08,0x10,0xf9,0x1f,0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x20,0x00,0x40,0x08,0x40,0x08,0x40,0xf9,0x3f,0x00,0x00,0x00,0x00,0xff,0x1f,0x80,0x01,0x40,0x01,0x20,0x02,0x10,0x04,0x08,0x18,0x00,0x00,0x00,0x00,0x01,0x10,0x01,0x10,0xff,0x1f,0x00,0x10,0x00,0x10,0xf8,0x1f,0x08,0x00,0x08,0x00,0xf0,0x1f,0x08,0x00,0x08,0x00,0xf0,0x1f,0x00,0x00,0xf8,0x1f,0x10,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0xf0,0x1f,0xe0,0x07,0x10,0x08,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x08,0xe0,0x07,0x00,0x00,0xf8,0xff,0x10,0x08,0x08,0x10,0x08,0x10,0x08,0x10,0xf0,0x0f,0x00,0x00,0xf0,0x0f,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x08,0xf8,0xff,0x00,0x00,0xf8,0x1f,0x10,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x10,0x00,0x00,0x08,0x70,0x10,0x88,0x10,0x88,0x10,0x08,0x11,0x08,0x11,0x10,0x0e,0x08,0x00,0x08,0x00,0xff,0x0f,0x08,0x10,0x08,0x10,0x08,0x10,0x00,0x08,0x00,0x00,0xf8,0x0f,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x08,0xf8,0x1f,0x38,0x00,0xc0,0x01,0x00,0x0e,0x00,0x10,0x00,0x0e,0xc0,0x01,0x38,0x00,0xf8,0x07,0x00,0x18,0x00,0x06,0x80,0x01,0x00,0x06,0x00,0x18,0xf8,0x07,0x18,0x18,0x20,0x04,0x40,0x02,0x80,0x01,0x40,0x02,0x20,0x04,0x18,0x18,0x18,0x00,0xe0,0xc0,0x00,0x33,0x00,0x0c,0x00,0x03,0xe0,0x00,0x18,0x00,0x08,0x18,0x08,0x14,0x08,0x12,0x88,0x11,0x48,0x10,0x28,0x10,0x18,0x10,0x00,0x00,0x00,0x00,0x4e,0x0e,0xb1,0x11,0x01,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x10,0xb1,0x11,0x4e,0x0e,0x00,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x80,0x00,0x00,0x01,0x00,0x01,0x80,0x00
};

void putFont(char c, uint8_t row, uint8_t col) {
  const uint8_t * p = FONTS + (c - ' ') * 14;
  uint16_t i = col * 8 + row;
  if (row > 6) return;
  if (col > 120) return;
  for (int8_t j = 0; j < 14;) {
    screen[i] = p[j++];
    screen[i + 1] = p[j++];
    i += 8;
  }
}

void ssdPutString(const char * s, uint8_t row, uint8_t col) {
  uint8_t i = 0;
  while (s[i]) {
    putFont(s[i++], row, col);
    col += 8;
    if (col == 128) {
      col = 0;
      row += 2;
    }
  }
}

void ssdRefresh() {
  GPIOB_ResetBits(GPIO_Pin_20);

  SPI0_MasterTrans((uint8_t []){ 0xA8, 63 }, 2);  // Multiplex ratio, height - 1
  SPI0_MasterTrans((uint8_t []){ 0xD3, 0x00 }, 2); // set display offset
  SPI0_MasterTrans((uint8_t []){ 0xD5, 0x80 }, 2); // set osc division

  SPI0_MasterTrans((uint8_t []){ 0x20, 0x01 }, 2);  // Memeory Address Mode

  SPI0_MasterTrans((uint8_t []){ 0xDA, 0x12 }, 2); // set COM pins
  SPI0_MasterTrans((uint8_t []){ 0xC8 }, 1); // COM Direction: C0: low to high, C8: high to low
  SPI0_MasterTrans((uint8_t []){ 0xA1 }, 1); // Segment mapping: A0: low to high, A1: high to low

  SPI0_MasterTrans((uint8_t []){ 0x40 }, 1); // display start line at 0
  SPI0_MasterTrans((uint8_t []){ 0xb0 }, 1); // page start at 0

  GPIOB_SetBits(GPIO_Pin_20);
  SPI0_MasterDMATrans(screen, 1024);
}

void ssdInit() {

  GPIOA_ModeCfg(GPIO_Pin_13, GPIO_ModeOut_PP_5mA); // SCLK
  GPIOA_ModeCfg(GPIO_Pin_14, GPIO_ModeOut_PP_5mA); // MOSI
  GPIOA_ModeCfg(GPIO_Pin_15, GPIO_ModeIN_Floating); // MISO

  GPIOB_ModeCfg(GPIO_Pin_21, GPIO_ModeOut_PP_5mA); // SSD1306: RST
  GPIOB_ModeCfg(GPIO_Pin_20, GPIO_ModeOut_PP_5mA); // SSD1306: DC, 0: Command, 1: Data

  SPI0_MasterDefInit();

  GPIOB_ResetBits(GPIO_Pin_21);
  delayInJiffy(60);
  GPIOB_SetBits(GPIO_Pin_21);

  GPIOB_ResetBits(GPIO_Pin_20);

  SPI0_MasterTrans((uint8_t []){ 0xAE }, 1);  // turn off
  SPI0_MasterTrans((uint8_t []){ 0x81, 0x80 }, 2);  // contrast
  SPI0_MasterTrans((uint8_t []){ 0xA8, 63 }, 2);  // Multiplex ratio, height - 1
  SPI0_MasterTrans((uint8_t []){ 0xD3, 0x00 }, 2); // set display offset
  SPI0_MasterTrans((uint8_t []){ 0xD5, 0x80 }, 2); // set osc division

  SPI0_MasterTrans((uint8_t []){ 0xD9, 0x1f }, 2); // set pre-charge period

  SPI0_MasterTrans((uint8_t []){ 0xDB, 0x40 }, 2); // set vcomh
  SPI0_MasterTrans((uint8_t []){ 0x8D, 0x14 }, 2); // set charge pump enable

  SPI0_MasterTrans((uint8_t []){ 0xA6 }, 1); // Display: A6: normal, A7: inverse

  SPI0_MasterTrans((uint8_t []){ 0x20, 0x01 }, 2);  // Memeory Address Mode

  SPI0_MasterTrans((uint8_t []){ 0xDA, 0x12 }, 2); // set COM pins
  SPI0_MasterTrans((uint8_t []){ 0xC8 }, 1); // COM Direction: C0: low to high, C8: high to low
  SPI0_MasterTrans((uint8_t []){ 0xA1 }, 1); // Segment mapping: A0: low to high, A1: high to low

  SPI0_MasterTrans((uint8_t []){ 0x2e }, 1); // turn off scroll

  SPI0_MasterTrans((uint8_t []){ 0x40 }, 1); // display start line at 0
  SPI0_MasterTrans((uint8_t []){ 0xb0 }, 1); // page start at 0

  SPI0_MasterTrans((uint8_t []){ 0xAF }, 1); // turn on

  memset(screen, 0x00, 1024);



  ssdRefresh();
}
